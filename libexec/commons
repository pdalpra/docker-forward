#!/usr/bin/env bash

set -e

SELECTED_VM_FILE="$HOME/.docker-forward-vm"
DEFAULT_VM_NAME="boot2docker-vm"

RULES_REGEX="^NIC 1 Rule.*"
PROTOCOL_REGEX="(tcp|udp)"
PORT_REGEX="guest port = ([[:digit:]]*)"

get_selected_vm() {
  specified_vm_name="$1"
  if [[ -n "$specified_vm_name" ]]; then
    echo "$specified_vm_name"
  else
    if [[ -f $SELECTED_VM_FILE ]]; then
      vm_name="$(cat "$SELECTED_VM_FILE")"
      if [[ -n "$vm_name" ]]; then
        echo "$vm_name"
      else
        echo "$DEFAULT_VM_NAME"
      fi
    else
      echo "$DEFAULT_VM_NAME"
    fi
  fi
}

extract() {
  input="$1"
  regex=$2
  [[ $input =~ $regex ]]
  echo "${BASH_REMATCH[1]}"
}

list_vms() {
  for line in "$(VBoxManage list vms)"; do
    while IFS=$' ' read -r vm id; do
      echo "$vm" | tr -d '\"'
    done <<< "$line"
  done
}

list_forwarded_ports() {
  vm_name="$1"
  rules_regex="^NIC 1 Rule.*"
  vm_info="$(VBoxManage showvminfo $(get_selected_vm $vm_name))"
  while IFS=$'\n' read -r line ; do
    if [[ "$line" =~ $RULES_REGEX ]]; then
      protocol=$(extract "$line" "$PROTOCOL_REGEX")
      port=$(extract "$line" "$PORT_REGEX")
      echo "$protocol/$port"
    fi
  done <<< "$vm_info"
}

vm_list_completions() {
    echo -e "$(list_vms)"
    exit 0
}
